# Data

## ERA5 and trajectory calculations

\cite{rothlisberger_quantifying_2023} applied their temperature anomaly decomposition (see [ Temperature anomaly decomposition]) to ERA5 data from 1980 to 2020 with $0.5^{\circ} \times 0.5^{\circ}$ horizontal resolution, 137 vertical coordinates expressed as model-levels and 3-hourly temporal resolution. ERA5 data is model output that has been assimilated with observation and therefore represents the most complete global product of gridded meteorological data. Near-surface temperature is represented by 2m temperature and $T'$ is calculated using transient climatologies of 9-year centered windows of 21-day periods, at every model-level. A complete description of ERA5 products may be found in \cite{hersbach_era5_2020}. 

This thesis considers the dataset generated by \cite{rothlisberger_quantifying_2023} in two ways: the first section will analyse the final decomposition of each TX1day event, while the second will analyse the timeseries that evolves when considering at each backward trajectory timestep the cumulative decomposition from genesis.

## Cumulative total

The former may be considered as a budget since it represents the total $T'$ accumulated over its trajectory. This yields an observational dataset containing - at every [latitude, longitude, year] index - the achieved $T'$ magnitude and the three contributors corresponding to $T'$ gained through advective, adiabatic and diabatic processes. We henceforth refer to these quantities as event $T'$, advective $T'$, adiabatic $T'$ and diabatic $T'$. Numerical residuals in \@ref(eq:tdecomp) - due to finite difference approximations of a continuous temporal domain - are usually small and thus ignored in future analysis. Furthermore, we assume that at a location [latitude, longitude], yearly samples are unaffected by local long-term temporal dependencies. Thus, for each location, the data consists in 41 independent draws from some multivariate distribution:
$$(T',\text{adv},\text{adiab},\text{diab}) \sim F $$
Initial exploration of the final decomposition shows a wide variety of marginal distributional behaviors, both for event $T'$ and each contributor. Figure \@ref(fig:flatdata) illustrates this for three representative locations. The event $T'$ histogram is bi-modal for the first location, normal for the second and right-skewed for the third. The bi-plots indicate mostly positive association between event $T'$ and each contributor, although this association is weak and even negative with advective $T'$ for the first location. The largest TX1day $T'$ does not necessarily develop from extremes in the contributors: for the first location the maximum event $T'$ is achieved with near-median values of advective and adiabatic $T'$ and only the 7th largest observed diabatic $T'$. The histograms of each contributor display mostly heavily skewed data and the pair-plots show mostly strong and diverse correlations between contributors as well as potentially non-linear associations. 

```{r flatdata, fig.cap="(a-c) Plots of TX1day $T'$ against the three contributors and (e-f) pair-plots for the contributors for years 1980 to 2020 for three locations. The $T'$ histogram is plotted on the top-right of the figure, and the contributor histograms with 8 bins are plotted below (e-f). The TX1day event acheiving largest $T'$ over the 41 events is plotted as a diamond.", echo=FALSE, out.width="100%", fig.pos = 'h'}
knitr::include_graphics("images/flat_data.png")
```

## Trajectory timeseries

At every [latitude, longitude, year] index, the second dataset considers the time-cumulative evolution of the parcel's $T'$, decomposed into the three contributors. Since each event may have a different genesis-time, all series are padded with zeros before their genesis time, yielding at each location 41 timeseries of length 121 - a trajectory history of 15 days with 3h intervals. The data displays again diverse structures, year-to-year as well as across space. Figure \@ref(fig:timeseriesdata) illustrates the year-to-year variability for one example location. Although some repeated structures are found in event $T'$ and contributor $T'$s across years, there are noisy periods and seemingly changing dynamics. For example, the graphs show some trajectories coupling and decoupling in time: the largest TX1day $T'$ event exhibits advective and diabatic $T'$ both decreasing until about 2 days before the event, then the diabatic $T'$ steeply increases while the advective $T'$ continues to decrease after a brief increase. The same pattern is observed between adiabatic and diabtic $T'$s - although with negative correlation - up to 2 days before and then only little association is observed. Some trajectories also exhibit sinusoidal behavior in diabatic $T'$ with period around 12h (see a number of samples between 10 days to 3 days before the events) which is explained by the day/night variation in solar radiation.

On average, the timeseries exhibit strong auto-correlation with final $T'$ at small time-lags, decreasing slowly until around 36h after which it cycles between 0.4 and 0.6. Strong auto-correlations are expected since the timeseries consider the accumulation of $T'$ in time. Advective and adiabatic $T'$ are poorly correlated with history older than 3 days, while diabatic $T'$ remains above 0.4. 

The cross-correlation between final event $T'$ and the contributor $T'$s is largest and positive for diabatic $T'$, slowly decreasing over 4 days with a sinusoidal behavior. The only negative correlation is with advective $T'$ and seems to be largest at longer time-lags. Further timeseries plots for locations chosen in \@ref(fig:flatdata) are included in Appendix A.1 and show different characteristics.

```{r timeseriesdata, fig.cap="(a-d) Plots of TX1day $T'$ decompositions at 16$^{\\circ}$S, 48$^{\\circ}$W (vicinity of Brazilia, Brazil) for years 1980 to 2020. The x-axis is logarithmic to better represent the recent history. The trajectory yielding the largest final $T'$ among all years is colored red, the time-mean of all trajectories in black and the inter-quantile range is highlighted in light blue. Plot (e) shows the (auto-)correlation between the final $T'$ and the $T'$ at different lags for the event and each contributor. Plot (f) shows the (cross-)correlation between the final event $T'$ and the $T'$ at different lags for each contributor. They are computed for all samples that have genesis time earlier than the considered time-lag.", echo=FALSE, out.width="100%", fig.pos = 'h'}
knitr::include_graphics("images/timeseries_data.png")
```

A common approach to reduce auto-correlation in timeseries is compute first-order differences ($(X^{(t)}-X^{(t-1)}$ for time $t=1,2,...,T$). However, differenced data in this application has been observed to yield noisy timeseries characterized by many local minima and maxima (see Appendix A.2) as well as considerable remaining auto-correlations. This behavior may hinder the ability of a machine learning model to learn meaningful patterns, and therefore the dataset is not differenced. 